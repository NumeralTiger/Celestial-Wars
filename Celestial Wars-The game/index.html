<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Arcade Shooter - Random Backgrounds & Full Game</title>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            font-family: sans-serif;
            color: #fff;
        }

    
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            overflow: hidden;
        }

        #spaceship-wrapper {
            position: absolute;
            pointer-events: none;
        }

        #spaceship {
            position: relative;
            width: 40px;
            height: 50px;
        }

        .ship-body {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 30px solid #0ff;
            filter: drop-shadow(0 0 5px #0ff);
        }

        .ship-mid {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, 0);
            width: 16px;
            height: 20px;
            background: #099;
            filter: drop-shadow(0 0 4px #0ff);
        }

        #ship-thruster {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, 0);
            width: 10px;
            height: 20px;
            background: linear-gradient(#f00, transparent);
            filter: drop-shadow(0 0 6px #f00);
            animation: thrusterIdle 0.4s infinite alternate;
        }

        @keyframes thrusterIdle {
            0% {
                height: 15px;
                box-shadow: 0 0 10px #f00;
            }

            100% {
                height: 25px;
                box-shadow: 0 0 15px #f90;
            }
        }

        .boost {
            animation: thrusterBoost 0.2s infinite alternate !important;
        }

        @keyframes thrusterBoost {
            0% {
                height: 30px;
                box-shadow: 0 0 15px 4px #f00;
            }

            100% {
                height: 45px;
                box-shadow: 0 0 25px 8px #ff0;
            }
        }

        .laser {
            position: absolute;
            width: 4px;
            height: 20px;
            background: linear-gradient(#ff0, #f80);
            box-shadow: 0 0 6px #ff0;
            pointer-events: none;
        }

        .laser-spread {
            position: absolute;
            width: 4px;
            height: 15px;
            background: linear-gradient(#0f0, #080);
            box-shadow: 0 0 6px #0f0;
            pointer-events: none;
        }

        .missile {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(#fff, #0ff);
            box-shadow: 0 0 8px #0ff;
            pointer-events: none;
        }

        .shockwave {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #f00;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 12px 4px #f00;
            pointer-events: none;
            animation: shockExpand 0.4s linear forwards;
        }

        @keyframes shockExpand {
            0% {
                transform: scale(0.01);
            }

            100% {
                transform: scale(5);
            }
        }

        .charged-beam {
            position: absolute;
            width: 12px;
            height: 30px;
            background: linear-gradient(#ff0, #f00);
            box-shadow: 0 0 12px #ff0;
            pointer-events: none;
        }

        .asteroid {
            position: absolute;
            background: #444;
            border: 2px solid #777;
            border-radius: 50%;
            box-shadow: 0 0 10px #222;
            pointer-events: none;
        }

        .spin {
            animation: spin 6s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0ff;
            text-shadow: 0 0 4px #0ff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #score-label,
        #lives-label {
            font-size: 16px;
        }

        #lives-container {
            display: inline-block;
        }

        .life-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 3px;
            background: #0f0;
            box-shadow: 0 0 4px #0f0;
        }

        #weapon-info {
            font-size: 14px;
        }

        #weapon-cooldown-bar {
            position: relative;
            width: 120px;
            height: 10px;
            background: #222;
            border: 1px solid #0ff;
            overflow: hidden;
        }

        #weapon-cooldown-fill {
            position: absolute;
            left: 0;
            top: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #0ff, #0cc);
            transition: width 0.1s linear;
        }

        #game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10000;
            display: none;
        }

        #game-over-overlay h1 {
            font-size: 3rem;
            color: #f33;
            text-shadow: 0 0 6px #fff;
            margin-bottom: 1rem;
        }

        #final-score {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        #restart-button {
            background: #222;
            color: #0ff;
            border: 2px solid #0ff;
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
            transition: background 0.2s;
        }

        #restart-button:hover {
            background: #0ff;
            color: #222;
        }

        #instructions-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10000;
        }

        #instructions-overlay h2 {
            font-size: 2rem;
            color: #0f0;
            margin-bottom: 1rem;
            text-shadow: 0 0 6px #fff;
        }

        #instructions-content {
            width: 80%;
            max-width: 600px;
            margin-bottom: 1rem;
            line-height: 1.5;
            font-size: 1rem;
            color: #fff;
            text-shadow: 0 0 4px #0ff;
        }

        #start-game-button {
            background: #222;
            color: #0ff;
            border: 2px solid #0ff;
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
            transition: background 0.2s;
        }

        #start-game-button:hover {
            background: #0ff;
            color: #222;
        }

        #leaderboard-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            text-align: center;
            color: #fff;
        }

        #leaderboard-overlay h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }

        #leaderboard-list li {
            margin: 0.4rem 0;
        }

        .leaderboard-btn {
            margin: 0.3rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            background: #222;
            color: #0ff;
            border: 2px solid #0ff;
            text-transform: uppercase;
            transition: background 0.2s;
        }

        .leaderboard-btn:hover {
            background: #0ff;
            color: #222;
        }

        #bg-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            text-align: center;
        }

        #bg-selection-overlay h2 {
            color: #fff;
            margin-bottom: 1.5rem;
        }

        .bg-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .bg-btn {
            padding: 1rem;
            cursor: pointer;
            border: 2px solid #fff;
            background: #333;
            color: #fff;
            text-transform: uppercase;
            transition: background 0.3s;
        }

        .bg-btn:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="bg-selection-overlay">
            <h2>Choose a background</h2>
            <div class="bg-buttons">
                <button class="bg-btn" id="bg-deep-space">Deep Space</button>
                <button class="bg-btn" id="bg-nebula">Nebula</button>
                <button class="bg-btn" id="bg-alien">Alien Planet</button>
                <button class="bg-btn" id="bg-random">Random</button>
            </div>
        </div>

        <div id="instructions-overlay">
            <h2>How to Play</h2>
            <div id="instructions-content">
                <p><strong>Movement:</strong> Use WASD or Arrow Keys to navigate.</p>
                <p><strong>Shoot & Charge:</strong> Use spacebar to fire. Hold it when using Charged Beam (Weapon 5).</p>
                <p><strong>Weapons (1-5):</strong>
                <p>1: Laser</p>
                <p>2: Spread Shot</p>
                <p>3: Seeker Missile</p>
                <p>4: Shockwave</p>
                <p>5: Charged Beam</p>
                <p>Destroy asteroids for score; don't collide or you lose lives.</p>
            </div>
            <button id="start-game-button">Start Game</button>
            <button id="view-leaderboard-btn" class="leaderboard-btn">View Leaderboard</button>
        </div>

        <!-- SPACESHIP -->
        <div id="spaceship-wrapper">
            <div id="spaceship">
                <div class="ship-body"></div>
                <div class="ship-mid"></div>
                <div id="ship-thruster"></div>
            </div>
        </div>

        <!-- UI -->
        <div id="ui">
            <div id="score-label">Score: <span id="score-value">0</span></div>
            <div id="lives-label">Lives: <span id="lives-container"></span></div>
            <div id="weapon-info">
                Current Weapon: <span id="weapon-name">Laser</span>
            </div>
            <div id="weapon-cooldown-bar">
                <div id="weapon-cooldown-fill"></div>
            </div>
        </div>

        <!-- GAME OVER OVERLAY -->
        <div id="game-over-overlay">
            <h1>GAME OVER</h1>
            <div id="final-score"></div>
            <button id="restart-button">Restart</button>
        </div>

        <!-- LEADERBOARD OVERLAY -->
        <div id="leaderboard-overlay">
            <h2>High Scores</h2>
            <ol id="leaderboard-list"></ol>
            <button id="close-leaderboard-button" class="leaderboard-btn">Close</button>
            <button id="reset-scores-button" class="leaderboard-btn">Reset Scores</button>
        </div>
    </div>

    <script>
        (function () {

            const backgrounds = [
                { name: "Deep Space", url: "Gravity Falls Journal.gif" },
                { name: "Nebula", url: "nebula.jpeg" },
                { name: "Alien Planet", url: "alien planet.webp" }
            ];

            const bgSelectionOverlay = document.getElementById('bg-selection-overlay');
            const btnDeepSpace = document.getElementById('bg-deep-space');
            const btnNebula = document.getElementById('bg-nebula');
            const btnAlien = document.getElementById('bg-alien');
            const btnRandom = document.getElementById('bg-random');
            const gameContainer = document.getElementById('game-container');

            function setBackground(bgObj) {
                gameContainer.style.backgroundImage = `url('${bgObj.url}')`;
            }

            // Pick a random background
            function setRandomBackground() {
                const randomIndex = Math.floor(Math.random() * backgrounds.length);
                setBackground(backgrounds[randomIndex]);
            }
            function closeBgOverlay() {
                bgSelectionOverlay.style.display = 'none';
            }

            // Event listeners for selection
            btnDeepSpace.addEventListener('click', () => {
                setBackground(backgrounds[0]);
                closeBgOverlay();
            });
            btnNebula.addEventListener('click', () => {
                setBackground(backgrounds[1]);
                closeBgOverlay();
            });
            btnAlien.addEventListener('click', () => {
                setBackground(backgrounds[2]);
                closeBgOverlay();
            });
            btnRandom.addEventListener('click', () => {
                setRandomBackground();
                closeBgOverlay();
            });


            let highScores = JSON.parse(localStorage.getItem('highScores')) || [];
            const MAX_SCORES = 5;

            const leaderboardOverlay = document.getElementById('leaderboard-overlay');
            const leaderboardList = document.getElementById('leaderboard-list');
            const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
            const resetScoresButton = document.getElementById('reset-scores-button');

            function checkAndUpdateHighScores() {
                if (highScores.length < MAX_SCORES || score > highScores[highScores.length - 1].score) {
                    const playerName = prompt("You got a high score! Enter your name or initials:");
                    const newScore = {
                        name: playerName && playerName.trim() ? playerName.trim() : "Anonymous",
                        score: score
                    };
                    highScores.push(newScore);
                    highScores.sort((a, b) => b.score - a.score);
                    highScores.splice(MAX_SCORES);
                    localStorage.setItem('highScores', JSON.stringify(highScores));
                }
            }

            function showLeaderboardOverlay() {
                leaderboardList.innerHTML = '';
                highScores = JSON.parse(localStorage.getItem('highScores')) || [];
                highScores.forEach((entry) => {
                    const li = document.createElement('li');
                    li.textContent = `${entry.name} - ${entry.score}`;
                    leaderboardList.appendChild(li);
                });
                leaderboardOverlay.style.display = 'flex';
            }
            function closeLeaderboardOverlay() {
                leaderboardOverlay.style.display = 'none';
            }
            function resetScores() {
                localStorage.removeItem('highScores');
                highScores = [];
                showLeaderboardOverlay();
            }
            closeLeaderboardButton.addEventListener('click', closeLeaderboardOverlay);
            resetScoresButton.addEventListener('click', resetScores);

            const instructionsOverlay = document.getElementById('instructions-overlay');
            const startGameButton = document.getElementById('start-game-button');
            const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');

            const spaceshipWrapper = document.getElementById('spaceship-wrapper');
            const thrusterEl = document.getElementById('ship-thruster');
            const scoreEl = document.getElementById('score-value');
            const livesContainer = document.getElementById('lives-container');
            const weaponNameEl = document.getElementById('weapon-name');
            const weaponCooldownEl = document.getElementById('weapon-cooldown-fill');
            const gameOverOverlay = document.getElementById('game-over-overlay');
            const finalScoreEl = document.getElementById('final-score');
            const restartBtn = document.getElementById('restart-button');

            const GAME_WIDTH = window.innerWidth;
            const GAME_HEIGHT = window.innerHeight;

            // Spaceship state
            let shipX = GAME_WIDTH / 2;
            let shipY = GAME_HEIGHT / 2;
            let shipVX = 0;
            let shipVY = 0;
            const maxSpeed = 5;
            const acceleration = 0.35;
            const friction = 0.92;

            // Controls
            let keyUp = false, keyDown = false, keyLeft = false, keyRight = false;
            let shooting = false;

            // Game state
            let lives = 3;
            let score = 0;
            let gameRunning = false;

            // Asteroids
            let asteroids = [];
            let lasers = [];
            let missiles = [];
            let shockwaves = [];
            let beams = [];

            // Difficulty
            let spawnInterval = 2000;
            let lastSpawnTime = 0;
            let difficultyCounter = 0;

            // Weapons
            let weaponMode = 1;
            const maxCooldown = 80;
            let weaponCooldown = 0;

            // Charged beam logic
            let charging = false;
            let chargeLevel = 0;
            const maxChargeLevel = 100;

            function initGame() {
                score = 0;
                lives = 3;
                updateLivesDisplay();
                scoreEl.textContent = score.toString();

                shipX = GAME_WIDTH / 2;
                shipY = GAME_HEIGHT / 2;
                shipVX = 0;
                shipVY = 0;

                asteroids.forEach(a => a.el.remove());
                asteroids = [];
                lasers.forEach(l => l.el.remove());
                lasers = [];
                missiles.forEach(m => m.el.remove());
                missiles = [];
                shockwaves.forEach(s => s.el.remove());
                shockwaves = [];
                beams.forEach(b => b.el.remove());
                beams = [];

                spawnInterval = 2000;
                lastSpawnTime = performance.now();
                difficultyCounter = 0;
                weaponCooldown = 0;
                chargeLevel = 0;
                charging = false;

                gameOverOverlay.style.display = 'none';
                instructionsOverlay.style.display = 'none';

                gameRunning = true;
                requestAnimationFrame(update);
            }

            function endGame() {
                gameRunning = false;
                finalScoreEl.textContent = 'Your Score: ' + score;
                gameOverOverlay.style.display = 'flex';
                checkAndUpdateHighScores();
            }

        
            function updateLivesDisplay() {
                livesContainer.innerHTML = '';
                for (let i = 0; i < lives; i++) {
                    const lifeEl = document.createElement('div');
                    lifeEl.className = 'life-indicator';
                    livesContainer.appendChild(lifeEl);
                }
            }
            function setWeaponName(mode) {
                switch (mode) {
                    case 1: weaponNameEl.textContent = 'Laser'; break;
                    case 2: weaponNameEl.textContent = 'Spread Shot'; break;
                    case 3: weaponNameEl.textContent = 'Seeker Missile'; break;
                    case 4: weaponNameEl.textContent = 'Shockwave'; break;
                    case 5: weaponNameEl.textContent = 'Charged Beam'; break;
                }
            }


            function spawnAsteroid() {
                const side = Math.floor(Math.random() * 4);
                let x, y, vx, vy;
                const size = 30 + Math.random() * 40;

                if (side === 0) { // top
                    x = Math.random() * GAME_WIDTH;
                    y = -size;
                    vx = (Math.random() - 0.5) * 2;
                    vy = 1 + Math.random() * 2;
                } else if (side === 1) { // right
                    x = GAME_WIDTH + size;
                    y = Math.random() * GAME_HEIGHT;
                    vx = -(1 + Math.random() * 2);
                    vy = (Math.random() - 0.5) * 2;
                } else if (side === 2) { // bottom
                    x = Math.random() * GAME_WIDTH;
                    y = GAME_HEIGHT + size;
                    vx = (Math.random() - 0.5) * 2;
                    vy = -(1 + Math.random() * 2);
                } else { // left
                    x = -size;
                    y = Math.random() * GAME_HEIGHT;
                    vx = 1 + Math.random() * 2;
                    vy = (Math.random() - 0.5) * 2;
                }

                const el = document.createElement('div');
                el.className = 'asteroid spin';
                el.style.width = size + 'px';
                el.style.height = size + 'px';
                gameContainer.appendChild(el);

                asteroids.push({
                    el, x, y, vx, vy, size
                });
            }
            function destroyAsteroid(index) {
                const a = asteroids[index];
                a.el.remove();
                asteroids.splice(index, 1);
            }
            function breakAsteroid(a) {
                if (a.size < 30) return;
                const fragCount = 2 + Math.floor(Math.random() * 2);
                const fragSize = a.size / fragCount;
                for (let i = 0; i < fragCount; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const speed = 1.5 + Math.random() * 2;
                    const fx = Math.cos(angle) * speed;
                    const fy = Math.sin(angle) * speed;

                    const el = document.createElement('div');
                    el.className = 'asteroid spin';
                    el.style.width = fragSize + 'px';
                    el.style.height = fragSize + 'px';
                    gameContainer.appendChild(el);

                    asteroids.push({
                        el,
                        x: a.x + a.size / 2 - fragSize / 2,
                        y: a.y + a.size / 2 - fragSize / 2,
                        vx: fx,
                        vy: fy,
                        size: fragSize
                    });
                }
            }

    
            function shootWeapon() {
                if (weaponCooldown > 0) return;
                if (weaponMode !== 5) {
                    weaponCooldown = 80;
                }
                switch (weaponMode) {
                    case 1: shootLaser(); break;
                    case 2: shootSpread(); break;
                    case 3: shootSeeker(); break;
                    case 4: shootShockwave(); break;
                    case 5: startChargingBeam(); break;
                }
            }

            // Basic Laser
            function shootLaser() {
                const laserEl = document.createElement('div');
                laserEl.className = 'laser';
                gameContainer.appendChild(laserEl);

                lasers.push({
                    el: laserEl,
                    x: shipX - 2,
                    y: shipY - 25,
                    vx: 0,
                    vy: -10,
                    width: 4,
                    height: 20
                });
            }
            // Spread Shot
            function shootSpread() {
                const angles = [-0.3, 0, 0.3];
                angles.forEach(angle => {
                    const spreadEl = document.createElement('div');
                    spreadEl.className = 'laser-spread';
                    gameContainer.appendChild(spreadEl);

                    const speed = 10;
                    const vx = speed * Math.sin(angle);
                    const vy = -speed * Math.cos(angle);

                    lasers.push({
                        el: spreadEl,
                        x: shipX - 2,
                        y: shipY - 20,
                        vx,
                        vy,
                        width: 4,
                        height: 15
                    });
                });
            }
            // Seeker
            function shootSeeker() {
                const missileEl = document.createElement('div');
                missileEl.className = 'missile';
                gameContainer.appendChild(missileEl);

                missiles.push({
                    el: missileEl,
                    x: shipX - 6,
                    y: shipY - 6,
                    vx: 0,
                    vy: -4
                });
            }
            // Shockwave
            function shootShockwave() {
                const waveEl = document.createElement('div');
                waveEl.className = 'shockwave';
                waveEl.style.left = (shipX - 10) + 'px';
                waveEl.style.top = (shipY - 10) + 'px';
                gameContainer.appendChild(waveEl);

                shockwaves.push({
                    el: waveEl,
                    x: shipX,
                    y: shipY,
                    radius: 0,
                    maxRadius: 120
                });
            }
            // Charged Beam
            function startChargingBeam() {
                charging = true;
            }
            function releaseChargedBeam() {
                if (chargeLevel > 20) {
                    const beamEl = document.createElement('div');
                    beamEl.className = 'charged-beam';
                    gameContainer.appendChild(beamEl);

                    const beamSize = 30 + (chargeLevel * 0.3);
                    beamEl.style.height = beamSize + 'px';

                    beams.push({
                        el: beamEl,
                        x: shipX - 6,
                        y: shipY - beamSize,
                        vx: 0,
                        vy: -15,
                        width: 12,
                        height: beamSize,
                        damage: 2 + Math.floor(chargeLevel / 20)
                    });
                }
                chargeLevel = 0;
                charging = false;
                weaponCooldown = 80;
            }

    
            function boxCollision(ax, ay, aw, ah, bx, by, bw, bh) {
                return (ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by);
            }
            function findClosestAsteroid(x, y) {
                let closest = null;
                let minDist = Infinity;
                for (let i = 0; i < asteroids.length; i++) {
                    const a = asteroids[i];
                    const dx = (a.x + a.size / 2) - x;
                    const dy = (a.y + a.size / 2) - y;
                    const dist = dx * dx + dy * dy;
                    if (dist < minDist) {
                        minDist = dist;
                        closest = a;
                    }
                }
                return closest;
            }

    
            function update() {
                if (!gameRunning) return;

                // Movement
                if (keyUp) shipVY -= acceleration;
                if (keyDown) shipVY += acceleration;
                if (keyLeft) shipVX -= acceleration;
                if (keyRight) shipVX += acceleration;

                shipVX *= friction;
                shipVY *= friction;

                if (shipVX > maxSpeed) shipVX = maxSpeed;
                if (shipVX < -maxSpeed) shipVX = -maxSpeed;
                if (shipVY > maxSpeed) shipVY = maxSpeed;
                if (shipVY < -maxSpeed) shipVY = -maxSpeed;

                shipX += shipVX;
                shipY += shipVY;

                const halfW = 20, halfH = 25;
                if (shipX < halfW) { shipX = halfW; shipVX = 0; }
                if (shipX > GAME_WIDTH - halfW) { shipX = GAME_WIDTH - halfW; shipVX = 0; }
                if (shipY < halfH) { shipY = halfH; shipVY = 0; }
                if (shipY > GAME_HEIGHT - halfH) { shipY = GAME_HEIGHT - halfH; shipVY = 0; }

                spaceshipWrapper.style.left = (shipX - halfW) + 'px';
                spaceshipWrapper.style.top = (shipY - halfH) + 'px';

                if (keyUp) thrusterEl.classList.add('boost');
                else thrusterEl.classList.remove('boost');

                // Lasers
                for (let i = lasers.length - 1; i >= 0; i--) {
                    const l = lasers[i];
                    l.x += l.vx;
                    l.y += l.vy;
                    if (l.x < -50 || l.x > GAME_WIDTH + 50 || l.y < -50 || l.y > GAME_HEIGHT + 50) {
                        l.el.remove();
                        lasers.splice(i, 1);
                        continue;
                    }
                    l.el.style.left = l.x + 'px';
                    l.el.style.top = l.y + 'px';
                }

                // Missiles
                for (let i = missiles.length - 1; i >= 0; i--) {
                    const m = missiles[i];
                    const target = findClosestAsteroid(m.x, m.y);
                    if (target) {
                        const angle = Math.atan2(
                            (target.y + target.size / 2) - m.y,
                            (target.x + target.size / 2) - m.x
                        );
                        m.vx += 0.2 * Math.cos(angle);
                        m.vy += 0.2 * Math.sin(angle);
                        const speedLimit = 6;
                        const speed = Math.sqrt(m.vx * m.vx + m.vy * m.vy);
                        if (speed > speedLimit) {
                            m.vx = (m.vx / speed) * speedLimit;
                            m.vy = (m.vy / speed) * speedLimit;
                        }
                    }
                    m.x += m.vx;
                    m.y += m.vy;
                    if (m.x < -50 || m.x > GAME_WIDTH + 50 || m.y < -50 || m.y > GAME_HEIGHT + 50) {
                        m.el.remove();
                        missiles.splice(i, 1);
                        continue;
                    }
                    m.el.style.left = m.x + 'px';
                    m.el.style.top = m.y + 'px';
                }

                // Shockwaves 
                for (let i = shockwaves.length - 1; i >= 0; i--) {
                    const sw = shockwaves[i];
                    sw.radius += 6;
                    for (let j = asteroids.length - 1; j >= 0; j--) {
                        const a = asteroids[j];
                        const distX = (a.x + a.size / 2) - sw.x;
                        const distY = (a.y + a.size / 2) - sw.y;
                        const dist = Math.sqrt(distX * distX + distY * distY);
                        if (dist < sw.radius + a.size * 0.5) {
                            destroyAsteroid(j);
                            if (a.size >= 30) {
                                breakAsteroid(a);
                            }
                            score += Math.floor(a.size);
                            scoreEl.textContent = score;
                        }
                    }
                    if (sw.radius > sw.maxRadius) {
                        sw.el.remove();
                        shockwaves.splice(i, 1);
                        continue;
                    }
                }

                //  Beams
                for (let i = beams.length - 1; i >= 0; i--) {
                    const b = beams[i];
                    b.x += b.vx;
                    b.y += b.vy;
                    if (b.x < -100 || b.x > GAME_WIDTH + 100 || b.y < -200 || b.y > GAME_HEIGHT + 200) {
                        b.el.remove();
                        beams.splice(i, 1);
                        continue;
                    }
                    b.el.style.left = b.x + 'px';
                    b.el.style.top = b.y + 'px';
                }

                // Asteroids
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const a = asteroids[i];
                    a.x += a.vx;
                    a.y += a.vy;
                    if (a.x < -200 || a.x > GAME_WIDTH + 200 || a.y < -200 || a.y > GAME_HEIGHT + 200) {
                        destroyAsteroid(i);
                        continue;
                    }
                    a.el.style.left = a.x + 'px';
                    a.el.style.top = a.y + 'px';
                }

                // Laser collisions
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const a = asteroids[i];
                    for (let j = lasers.length - 1; j >= 0; j--) {
                        const l = lasers[j];
                        if (boxCollision(a.x, a.y, a.size, a.size, l.x, l.y, l.width, l.height)) {
                            destroyAsteroid(i);
                            if (a.size >= 30) {
                                breakAsteroid(a);
                            }
                            score += Math.floor(a.size);
                            scoreEl.textContent = score;
                            l.el.remove();
                            lasers.splice(j, 1);
                            break;
                        }
                    }
                }

                //Missile collisions
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const a = asteroids[i];
                    for (let j = missiles.length - 1; j >= 0; j--) {
                        const m = missiles[j];
                        if (boxCollision(a.x, a.y, a.size, a.size, m.x, m.y, 12, 12)) {
                            destroyAsteroid(i);
                            if (a.size >= 30) {
                                breakAsteroid(a);
                            }
                            score += Math.floor(a.size);
                            scoreEl.textContent = score;
                            m.el.remove();
                            missiles.splice(j, 1);
                            break;
                        }
                    }
                }

                // Beam collisions
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const a = asteroids[i];
                    for (let j = beams.length - 1; j >= 0; j--) {
                        const b = beams[j];
                        if (boxCollision(a.x, a.y, a.size, a.size, b.x, b.y, b.width, b.height)) {
                            destroyAsteroid(i);
                            if (a.size >= 30) {
                                breakAsteroid(a);
                            }
                            score += Math.floor(a.size) * b.damage;
                            scoreEl.textContent = score;
                            b.el.remove();
                            beams.splice(j, 1);
                            break;
                        }
                    }
                }

                //Asteroid and Ship collision
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const a = asteroids[i];
                    if (boxCollision(a.x, a.y, a.size, a.size, shipX - halfW, shipY - halfH, 40, 50)) {
                        lives--;
                        updateLivesDisplay();
                        destroyAsteroid(i);
                        if (lives <= 0) {
                            endGame();
                            return;
                        }
                    }
                }

                // Weapon cooldown
                if (weaponCooldown > 0) {
                    weaponCooldown--;
                }
                const fillPct = 100 - (weaponCooldown / maxCooldown) * 100;
                weaponCooldownEl.style.width = Math.max(0, fillPct) + '%';

                //  Charge beam
                if (charging) {
                    chargeLevel = Math.min(maxChargeLevel, chargeLevel + 1);
                }

                // Difficulty & spawn
                difficultyCounter++;
                if (difficultyCounter % 600 === 0) {
                    spawnInterval = Math.max(500, spawnInterval - 200);
                }
                const now = performance.now();
                if (now - lastSpawnTime > spawnInterval) {
                    lastSpawnTime = now;
                    spawnAsteroid();
                }

                requestAnimationFrame(update);
            }

           
            window.addEventListener('keydown', e => {
                if (e.code === 'ArrowUp' || e.code === 'KeyW') keyUp = true;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') keyDown = true;
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') keyLeft = true;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') keyRight = true;

                if (e.code === 'Space') {
                    shooting = true;
                    if (weaponMode !== 5) {
                        shootWeapon();
                    } else {
                        shootWeapon(); // starts charging
                    }
                }

                // Switch weapons
                if (e.code === 'Digit1') { weaponMode = 1; setWeaponName(1); }
                if (e.code === 'Digit2') { weaponMode = 2; setWeaponName(2); }
                if (e.code === 'Digit3') { weaponMode = 3; setWeaponName(3); }
                if (e.code === 'Digit4') { weaponMode = 4; setWeaponName(4); }
                if (e.code === 'Digit5') { weaponMode = 5; setWeaponName(5); }

                if (instructionsOverlay.style.display !== 'none' && e.code === 'Enter') {
                    hideInstructionsAndStart();
                }
            });

            window.addEventListener('keyup', e => {
                if (e.code === 'ArrowUp' || e.code === 'KeyW') keyUp = false;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') keyDown = false;
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') keyLeft = false;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') keyRight = false;

                if (e.code === 'Space') {
                    shooting = false;
                    if (weaponMode === 5 && charging) {
                        releaseChargedBeam();
                    }
                }
            });

            restartBtn.addEventListener('click', initGame);


            function hideInstructionsAndStart() {
                instructionsOverlay.style.display = 'none';
                initGame();
            }
            startGameButton.addEventListener('click', hideInstructionsAndStart);
            viewLeaderboardBtn.addEventListener('click', showLeaderboardOverlay);

            function setup() {
                setWeaponName(1);
                updateLivesDisplay();
            }
            setup();
        })();
    </script>
</body>

</html>
